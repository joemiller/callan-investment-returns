<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Callan-Style Daily Returns</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  <script type="importmap">
  {
    "imports": {
      "react": "https://esm.sh/react@18",
      "react-dom/client": "https://esm.sh/react-dom@18/client",
      "recharts": "https://esm.sh/recharts@2.12.7?external=react"
    }
  }
  </script>
  <script type="module">
    import React, { useState, useEffect, useMemo } from 'react';
    import { createRoot } from 'react-dom/client';
    import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';

    const CURRENT_YEAR = new Date().getFullYear();

    function filterDataForView(rawPrices, assetClasses, view) {
      if (!rawPrices || rawPrices.length === 0) return [];

      const now = new Date();
      let startDate, endDate;

      if (view === 'YTD') {
        startDate = `${CURRENT_YEAR}-01-01`;
        endDate = now.toISOString().split('T')[0];
      } else if (view === 'L12M') {
        const twelveMonthsAgo = new Date(now);
        twelveMonthsAgo.setFullYear(twelveMonthsAgo.getFullYear() - 1);
        startDate = twelveMonthsAgo.toISOString().split('T')[0];
        endDate = now.toISOString().split('T')[0];
      } else {
        const year = parseInt(view, 10);
        startDate = `${year}-01-01`;
        endDate = year === CURRENT_YEAR ? now.toISOString().split('T')[0] : `${year}-12-31`;
      }

      const filtered = rawPrices.filter(d => d.date >= startDate && d.date <= endDate);
      if (filtered.length === 0) return [];

      const baseValues = {};
      assetClasses.forEach(a => {
        if (filtered[0][a.name] !== undefined) {
          baseValues[a.name] = filtered[0][a.name];
        }
      });

      return filtered.map(d => {
        const point = {
          date: d.date,
          displayDate: `${parseInt(d.date.slice(5, 7))}/${parseInt(d.date.slice(8, 10))}`,
        };
        assetClasses.forEach(a => {
          if (d[a.name] !== undefined && baseValues[a.name]) {
            point[a.name] = parseFloat((((d[a.name] / baseValues[a.name]) - 1) * 100).toFixed(2));
          }
        });
        return point;
      });
    }

    function App() {
      const [rawData, setRawData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [selectedView, setSelectedView] = useState('YTD');
      const [visibleLines, setVisibleLines] = useState({});

      const viewOptions = useMemo(() => {
        const opts = [
          { id: 'YTD', label: `${CURRENT_YEAR} YTD` },
          { id: 'L12M', label: 'Last 12 Months' },
        ];
        for (let year = CURRENT_YEAR - 1; year >= CURRENT_YEAR - 4; year--) {
          opts.push({ id: String(year), label: String(year) });
        }
        return opts;
      }, []);

      useEffect(() => {
        fetch('data.json')
          .then(res => {
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return res.json();
          })
          .then(data => {
            setRawData(data);
            setVisibleLines(Object.fromEntries(data.asset_classes.map(a => [a.name, true])));
            setLoading(false);
          })
          .catch(err => {
            setError(err.message);
            setLoading(false);
          });
      }, []);

      const chartData = useMemo(() => {
        if (!rawData) return [];
        return filterDataForView(rawData.prices, rawData.asset_classes, selectedView);
      }, [rawData, selectedView]);

      function toggleLine(name) {
        setVisibleLines(prev => ({ ...prev, [name]: !prev[name] }));
      }

      function selectAll() {
        if (!rawData) return;
        setVisibleLines(Object.fromEntries(rawData.asset_classes.map(a => [a.name, true])));
      }

      function selectNone() {
        if (!rawData) return;
        setVisibleLines(Object.fromEntries(rawData.asset_classes.map(a => [a.name, false])));
      }

      function getCurrentReturns() {
        if (!rawData || chartData.length === 0) return [];
        const latest = chartData[chartData.length - 1];
        return rawData.asset_classes
          .map(a => ({ ...a, return: latest[a.name] }))
          .filter(a => a.return !== undefined)
          .sort((a, b) => b.return - a.return);
      }

      const sortedReturns = getCurrentReturns();
      const latestDate = chartData.length > 0 ? chartData[chartData.length - 1].date : null;
      const startDate = chartData.length > 0 ? chartData[0].date : null;
      const viewLabel = viewOptions.find(v => v.id === selectedView)?.label || selectedView;

      if (loading) {
        return React.createElement('div', { className: 'flex items-center justify-center min-h-screen' },
          React.createElement('div', { className: 'text-gray-500' }, 'Loading data...')
        );
      }

      if (error) {
        return React.createElement('div', { className: 'flex items-center justify-center min-h-screen' },
          React.createElement('div', { className: 'text-red-500' }, `Error: ${error}`)
        );
      }

      return React.createElement('div', { className: 'p-4 bg-white min-h-screen' },
        React.createElement('div', { className: 'max-w-6xl mx-auto' },
          React.createElement('h1', { className: 'text-2xl font-bold text-gray-800 mb-1' },
            'Callan-Style Daily Returns'
          ),
          React.createElement('p', { className: 'text-sm text-gray-500 mb-4' },
            'Cumulative returns by asset class',
            startDate && latestDate && React.createElement('span', { className: 'ml-2' },
              `• ${viewLabel}: ${startDate} to ${latestDate}`
            ),
            rawData?.updated_at && React.createElement('span', { className: 'ml-2 text-gray-400' },
              `• Updated: ${new Date(rawData.updated_at).toLocaleDateString()}`
            )
          ),

          // Time period selector
          React.createElement('div', { className: 'flex flex-wrap gap-1 mb-4' },
            viewOptions.map(opt =>
              React.createElement('button', {
                key: opt.id,
                onClick: () => setSelectedView(opt.id),
                className: `px-3 py-1.5 rounded text-sm font-medium transition-all ${
                  selectedView === opt.id
                    ? 'bg-gray-800 text-white'
                    : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                }`
              }, opt.label)
            )
          ),

          // ETF toggles
          React.createElement('div', { className: 'flex flex-wrap gap-2 mb-2 items-center' },
            React.createElement('span', { className: 'text-sm text-gray-500 mr-1' }, 'ETFs:'),
            React.createElement('button', {
              onClick: selectAll,
              className: 'px-2 py-0.5 text-xs bg-gray-200 hover:bg-gray-300 rounded'
            }, 'All'),
            React.createElement('button', {
              onClick: selectNone,
              className: 'px-2 py-0.5 text-xs bg-gray-200 hover:bg-gray-300 rounded'
            }, 'None'),
            React.createElement('span', { className: 'text-gray-300 mx-1' }, '|'),
            rawData?.asset_classes.map(asset => {
              const hasData = chartData.length > 0 && chartData[chartData.length - 1][asset.name] !== undefined;
              return React.createElement('button', {
                key: asset.name,
                onClick: () => toggleLine(asset.name),
                disabled: !hasData,
                className: `px-2 py-1 rounded text-xs font-medium transition-all ${
                  !hasData ? 'bg-gray-100 text-gray-300 cursor-not-allowed' :
                  visibleLines[asset.name] ? 'text-white' : 'bg-gray-100 text-gray-400'
                }`,
                style: hasData && visibleLines[asset.name] ? { backgroundColor: asset.color } : {}
              }, asset.symbol);
            })
          ),

          // Chart
          React.createElement('div', { className: 'bg-gray-50 rounded-lg p-4 mb-4' },
            chartData.length === 0
              ? React.createElement('div', { className: 'h-96 flex items-center justify-center text-gray-400' },
                  'No data available for this time period'
                )
              : React.createElement(ResponsiveContainer, { width: '100%', height: 400 },
                  React.createElement(LineChart, { data: chartData, margin: { top: 5, right: 30, left: 0, bottom: 5 } },
                    React.createElement(CartesianGrid, { strokeDasharray: '3 3', stroke: '#e0e0e0' }),
                    React.createElement(XAxis, {
                      dataKey: 'displayDate',
                      tick: { fontSize: 11 },
                      interval: 'preserveStartEnd'
                    }),
                    React.createElement(YAxis, {
                      tickFormatter: (v) => `${v}%`,
                      tick: { fontSize: 11 },
                      domain: ['auto', 'auto']
                    }),
                    React.createElement(Tooltip, {
                      content: ({ active, payload, label }) => {
                        if (!active || !payload || payload.length === 0) return null;
                        const sorted = [...payload].sort((a, b) => b.value - a.value);
                        return React.createElement('div', {
                          className: 'bg-white border border-gray-200 rounded shadow-lg p-2 text-sm'
                        },
                          React.createElement('div', { className: 'text-gray-600 mb-1' }, `Date: ${label}`),
                          sorted.map(item =>
                            React.createElement('div', {
                              key: item.dataKey,
                              className: 'flex justify-between gap-4',
                              style: { color: item.color }
                            },
                              React.createElement('span', null, item.name),
                              React.createElement('span', { className: 'font-mono' },
                                `${item.value >= 0 ? '+' : ''}${item.value.toFixed(2)}%`
                              )
                            )
                          )
                        );
                      }
                    }),
                    React.createElement(Legend),
                    ...(rawData?.asset_classes || []).filter(a => visibleLines[a.name]).map(asset =>
                      React.createElement(Line, {
                        key: asset.name,
                        type: 'monotone',
                        dataKey: asset.name,
                        stroke: asset.color,
                        strokeWidth: 2,
                        dot: false,
                        connectNulls: true
                      })
                    )
                  )
                )
          ),

          // Rankings
          sortedReturns.length > 0 && React.createElement('div', { className: 'bg-gray-50 rounded-lg p-4' },
            React.createElement('h2', { className: 'text-lg font-semibold text-gray-700 mb-3' },
              `${viewLabel} Rankings`
            ),
            React.createElement('div', { className: 'grid grid-cols-1 sm:grid-cols-3 gap-2' },
              sortedReturns.map((item, idx) =>
                React.createElement('div', {
                  key: item.name,
                  className: 'flex items-center justify-between p-2 rounded',
                  style: { backgroundColor: `${item.color}15` }
                },
                  React.createElement('span', { className: 'flex items-center gap-2' },
                    React.createElement('span', { className: 'text-gray-500 font-mono w-5' }, `${idx + 1}.`),
                    React.createElement('span', {
                      className: 'w-3 h-3 rounded-full',
                      style: { backgroundColor: item.color }
                    }),
                    React.createElement('span', { className: 'font-medium text-gray-700' }, `${item.name} (${item.symbol})`)
                  ),
                  React.createElement('span', {
                    className: `font-mono font-semibold ${item.return >= 0 ? 'text-green-600' : 'text-red-600'}`
                  }, `${item.return >= 0 ? '+' : ''}${item.return.toFixed(2)}%`)
                )
              )
            )
          ),

          React.createElement('div', { className: 'mt-6 pt-4 border-t border-gray-200 text-xs text-gray-400' },
            React.createElement('p', null,
              'Data updated daily via GitHub Actions. Source: Yahoo Finance.'
            ),
            React.createElement('p', { className: 'mt-1' },
              'ETF proxies: SPY (Large Cap), IWM (Small Cap), EFA (Dev ex-US), EEM (Emerging), REET (Real Estate), AGG (US Bonds), BNDX (Intl Bonds), HYG (High Yield), BIL (Cash)'
            ),
            React.createElement('details', { className: 'mt-3' },
              React.createElement('summary', { className: 'cursor-pointer hover:text-gray-600' },
                'Notes on ETF selection vs Callan methodology'
              ),
              React.createElement('div', { className: 'mt-2 pl-4 text-gray-500 space-y-2' },
                React.createElement('p', null,
                  React.createElement('strong', null, 'Real Estate (REET): '),
                  'Callan uses the FTSE EPRA Nareit Developed REIT Index. REET tracks the Global variant (developed + emerging). Emerging markets are ~5-10% of REET; over 70% is US-based. No US-listed ETF tracks the exact Developed variant.'
                ),
                React.createElement('p', null,
                  React.createElement('strong', null, 'Intl Fixed Income (BNDX): '),
                  'Callan uses the Bloomberg Global Aggregate ex-US Index unhedged. BNDX is USD-hedged, causing return differences when the USD moves significantly. No US-listed ETF tracks the unhedged aggregate (alternatives like IGOV/BWX are treasury-only, missing corporate bonds).'
                )
              )
            ),
            React.createElement('p', { className: 'mt-3' },
              React.createElement('a', {
                href: 'https://github.com/joemiller/callan-investment-returns',
                target: '_blank',
                rel: 'noopener noreferrer',
                className: 'hover:text-gray-600'
              }, 'View source on GitHub')
            )
          )
        )
      );
    }

    const root = createRoot(document.getElementById('root'));
    root.render(React.createElement(App));
  </script>
</body>
</html>
